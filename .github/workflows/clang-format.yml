name: clang-format-check

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main
  workflow_dispatch:

jobs:
  format-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Main Branch Name
        id: main-branch
        run: |
          # Get the default branch name from the repository
          MAIN_BRANCH=$(git remote show origin | grep 'HEAD branch' | awk '{print $3}')
          echo "Main branch is: $MAIN_BRANCH"
          echo "main_branch=$MAIN_BRANCH" >> $GITHUB_ENV  # Set it as an environment variable

      - name: Fetch Main Branch
        run: |
          git fetch origin ${{ env.main_branch }}  # Fetch the main branch

      - name: Install clang-format
        run: sudo apt-get install -y clang-format

      - name: Download clang-format-diff.py
        run: |
          wget https://raw.githubusercontent.com/llvm/llvm-project/main/clang/tools/clang-format/clang-format-diff.py
          chmod +x clang-format-diff.py

      #run formatter inline
      - name: Format changed lines
        id: formatstep
        env:
          ACTIONS_RUNNER_DEBUG: true
        run: |
          # Format only the changed lines using clang-format-diff.py
          git branch
          git diff -U0 --no-color origin/${{ env.main_branch }} HEAD | python3 clang-format-diff.py -p1 > formatted_differences.patch

      # check if differences found after formatting
      - name: Check formatting needed
        id: diffstep
        run: |
          if [ -s formatted_differences.patch ]; then
            echo "Formatting issues found!. Formatted changes:"
            cat formatted_differences.patch
            rm formatted_differences.patch
            exit 1
          fi